<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <style type="text/css">
      * {
        padding: 0;
        margin: 0;
        vertical-align: baseline;
        list-style: none;
        border: 0;
      }
      html,
      body {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div
      id="container"
      style="display:flex; flex-direction: row; justify-content: center; min-height:100%"
    >
      <div
        style="flex:3; display:flex;flex-direction:column; align-content: center; justify-content: center ; padding:20px;"
      >
        <div id="playerInfo" style="display:flex; justify-content: center;">
          <input
            type="text"
            id="playerName"
            style="border: 1px solid #c0c0c0; line-height: 20px;"
            placeholder="Nome"
          />
          <input
            type="submit"
            value="Jogar!"
            onclick="play()"
            style="font-weight:bold; margin-left:20px; width:150px; border: 1px solid #c0c0c0; color:white; background-color:#6f00ff"
          />
        </div>
        <div
          id="gameContainer"
          style="display:none; flex:1; justify-content: center; align-items:center"
        >
          <canvas
            id="game"
            width="800"
            height="600"
            style="box-shadow: 0 0 5px #f8f8f8; background-color: #f8f8f8;"
          >
          </canvas>
          <audio
            id="audioCoin"
            src="https://themushroomkingdom.net/sounds/wav/smw/smw_coin.wav"
            preload="auto"
          ></audio>
        </div>
      </div>
      <div
        id="placar"
        style="background-color:#e4e4e4; display:none;flex-direction: column;align-items: center; flex:1"
      >
        <span style="margin-top:20px;margin-bottom:20px"><b>Placar</b></span>
        <div id="player"></div>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    var socket = io("http://192.168.0.28:3000");

    const ctx = document.getElementById("game").getContext("2d");

    const UP = 37;
    const LEFT = 38;
    const DOWN = 39;
    const RIGHT = 40;

    const pixelsPerStep = 20;

    var lastKeyPressed;

    var players = [];
    var currentPlayer = null;
    var fruits = [];

    $(document).ready(function() {
      $(document).keydown(function(e) {
        processInput(e.keyCode || e.which);
      });
    });

    $(window).on("unload", function() {
      players = players.filter(function(currentPlayer) {
        return currentPlayer.id !== socket.id;
      });
      socket.disconnect();
      return "ok";
    });

    var processInput = function(keyCode) {
      lastKeyPressed = keyCode;

      if (players.length > 0) {
        updatePlayerPosition();

        var tempPlayer = players.find(p => p.id === socket.id);

        tempPlayer.x = currentPlayer.x;
        tempPlayer.y = currentPlayer.y;
        tempPlayer.points = currentPlayer.points;

        socket.emit("updatePlayer", currentPlayer);
      }
    };

    var updatePlayerPosition = function() {
      if (currentPlayer) {
        if (lastKeyPressed == UP) {
          if (currentPlayer.x - pixelsPerStep < 0) {
            currentPlayer.x = 780;
          } else {
            currentPlayer.x -= pixelsPerStep;
          }
        } else if (lastKeyPressed == DOWN) {
          if (currentPlayer.x + pixelsPerStep >= 800) {
            currentPlayer.x = 0;
          } else {
            currentPlayer.x += pixelsPerStep;
          }
        } else if (lastKeyPressed == LEFT) {
          if (currentPlayer.y - pixelsPerStep < 0) {
            currentPlayer.y = 580;
          } else {
            currentPlayer.y -= pixelsPerStep;
          }
        } else if (lastKeyPressed == RIGHT) {
          if (currentPlayer.y + pixelsPerStep >= 600) {
            currentPlayer.y = 0;
          } else {
            currentPlayer.y += pixelsPerStep;
          }
        }
        var capturedFruit = fruits.find(
          f => f.x === currentPlayer.x && f.y === currentPlayer.y
        );

        if (capturedFruit) {
          console.log(
            "capturedFruit: ",
            capturedFruit.x,
            capturedFruit.y,
            currentPlayer.name,
            currentPlayer.x,
            currentPlayer.y
          );
          currentPlayer.points += capturedFruit.points;
          socket.emit("capturedFruit", capturedFruit);
          fruits = fruits.filter(function(f) {
            return !(f.x == capturedFruit.x && f.y == capturedFruit.y);
          });

          if (currentPlayer.points % 10 === 0) {
            document.getElementById("audioCoin").play();
          }
        }

        lastKeyPressed = null;
      }
    };

    socket.on("createdPlayers", data => {
      players = data;
      currentPlayer = players.find(p => p.id === socket.id);
    });

    socket.on("updateGame", function(data) {
      players = data;
    });

    socket.on("createdFruits", function(data) {
      fruits = data;
    });

    var render = function() {
      ctx.clearRect(0, 0, 800, 600);
      document.getElementById("player").innerHTML = "";
      for (player of players) {
        if (socket.id === player.id) {
          ctx.fillStyle = "#6f00ff";
        } else {
          ctx.fillStyle = "#c0c0c0";
        }
        ctx.fillRect(player.x, player.y, 20, 20);

        if (player.id === socket.id) {
          document.getElementById("player").innerHTML +=
            "<b style='color:#6f00ff'>" +
            player.name +
            " - " +
            player.points +
            " points.</b><br/>";
        } else {
          document.getElementById("player").innerHTML +=
            "<span style='color:#000'>" +
            player.name +
            " - " +
            player.points +
            " points.</span><br/>";
        }
      }
      renderFruits();

      window.requestAnimationFrame(render);
    };

    var renderFruits = function() {
      for (fruit of fruits) {
        ctx.fillStyle = "green";
        ctx.fillRect(fruit.x, fruit.y, 20, 20);
      }
    };

    var play = function() {
      if (
        document
          .getElementById("playerName")
          .value.toString()
          .trim() === ""
      ) {
        alert("Favor informar o nome.");
      } else {
        socket.emit("startGame", {
          name: document.getElementById("playerName").value
        });
        document.getElementById("gameContainer").style.display = "flex";
        document.getElementById("placar").style.display = "flex";
        document.getElementById("playerInfo").style.display = "none";
        window.requestAnimationFrame(render);
      }
    };
    //
  </script>
</html>
